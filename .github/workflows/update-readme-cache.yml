name: ♻️ Update cache_bust & timestamp daily at 22:45 WIB

on:
  schedule:
    - cron: "45 15 * * *"  
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout repository (default branch: main)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  

      - name: ⚙️ Konfigurasi Git
        run: |
          git config user.name "zreechxnn"
          git config user.email "zreechxnn@users.noreply.github.com"

      - name: 🛠️ Checkout ke branch `output` dan update README.md
        run: |
          # Simpan commit terakhir untuk kembali jika perlu
          git stash

          # Buat branch output jika belum ada
          git fetch origin output || true
          git checkout output || git checkout -b output

          # Ambil kembali perubahan dari stash (README.md workflow hasil generate)
          git stash pop || echo "🗒️ Tidak ada stash untuk dipulihkan"

          FECHA=$(date -u '+%Y%m%d')
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          echo "🕒 Update README.md: $TIMESTAMP"

          # Update timestamp di baris pertama
          sed -i "1s|^.*$|<!-- Última actualización: $TIMESTAMP -->|" README.md

          # Hilangkan cache_bust lama
          sed -i -E 's|(https://github-readme-stats\.vercel\.app/api/pin/[^"]*)&cache_bust=[0-9]{8}|\1|g' README.md

          # Tambahkan cache_bust baru
          sed -i -E 's|(src="https://github-readme-stats\.vercel\.app/api/pin/[^"]+)(\")|\1\&cache_bust='"$FECHA"'\2|g' README.md

          # Commit jika ada perubahan
          if git diff --quiet; then
            echo "✅ Tidak ada perubahan, tidak perlu commit."
          else
            git add README.md
            git commit -m "♻️ cache_bust diperbarui ke $FECHA"
            git push -f origin output
            echo "✅ README.md berhasil dipush ke branch 'output'."
          fi
